
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Ping as a Service (PaaS) &#8212; Little Riak Core Book 1.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Metrics" href="metrics.html" />
    <link rel="prev" title="Starting" href="starting.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ping-as-a-service-paas">
<h1>Ping as a Service (PaaS)<a class="headerlink" href="#ping-as-a-service-paas" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While the content of this book is still valid, the code may not run with
latest versions of the tools and libraries, for an updated version of the
code check the <a class="reference external" href="https://marianoguerra.github.io/riak-core-tutorial/">Riak Core Tutorial</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This chapter and the following ones will reference a real project in a
github repository, follow the links to see the details of what is written
here.</p>
</div>
<div class="section" id="setting-up">
<h2>Setting Up<a class="headerlink" href="#setting-up" title="Permalink to this headline">¶</a></h2>
<p>After setting up our project we will now expose ping as a REST API, for that
we will use <a class="reference external" href="http://ninenines.eu/docs/en/cowboy/1.0/">The Cowboy Web Server</a>.</p>
<p>For JSON parsing we will use <a class="reference external" href="https://github.com/talentdeficit/jsx">jsx</a>.</p>
<p>Here is the <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/b86718c1b8e8689ca8adb15627f59ce44c486bfc">commit to add the dependencies</a>.</p>
<p>We also add the <a class="reference external" href="http://www.rebar3.org/docs/dependencies#dependency-lock-management">rebar.lock</a>
file to make our builds reproducible.</p>
<p>Just in case we want to use another json library later and to simplify the calls
we <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/fdccd5e2863c8c71599bcd38a26e8b8b5fcd5219">wrap the json library in our own module</a>.</p>
<p>Finally we create a <a class="reference external" href="http://ninenines.eu/docs/en/cowboy/1.0/manual/cowboy_rest/">cowboy rest handler</a> for our ping resource, <a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/220bcade820538aec05993065ac4edf19f3ebcde/apps/tanodb/src/tanodb_http_ping.erl">tanodb_http_ping.erl</a> and <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/220bcade820538aec05993065ac4edf19f3ebcde">initialize cowboy in tanodb_app</a>.</p>
</div>
<div class="section" id="update-changes-required-to-make-this-code-run-as-of-2016-05-03">
<h2>UPDATE: changes required to make this code run as of 2016-05-03<a class="headerlink" href="#update-changes-required-to-make-this-code-run-as-of-2016-05-03" title="Permalink to this headline">¶</a></h2>
<p>Since this chapter was written some things changed in rebar3 and the plugins
that we use, the best way would be for you to start with the current version
of <a class="reference external" href="https://github.com/marianoguerra/rebar3_template_riak_core/">rebar3 riak_core template</a>
and apply the changes there, but if you want to make this commit run you have to do the following changes:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-de0bb192480d6c77fc513569c365f507R12">Add cowboy and jsx to applications section in tanodb.app.src</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-a3d3e872d1ee1809a4e8de03058809abR18">Add crash_dump config variable to vars.config to avoid malformed generated config file</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-31d7a50c99c265ca2793c20961b60979R16">Add riak_core to list of dependencies on rebar.config</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-31d7a50c99c265ca2793c20961b60979L19">Remove now unneeded config fields for relx in rebar.config</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-31d7a50c99c265ca2793c20961b60979L49">Make rebar3_release a project_plugin</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-31d7a50c99c265ca2793c20961b60979L64">Remove cuttlefish provider_hook</a></li>
<li><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/188ea3d0cd0278082acd20c9b7a67bb1f1092b83#diff-31d7a50c99c265ca2793c20961b60979L87">Add override to make riak_ensemble compile correctly</a></li>
</ul>
<p>All this changes are in a branch that you can fetch and try:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">checkout</span> <span class="n">ping</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">fix</span><span class="o">-</span><span class="mi">1</span>
<span class="n">rebar3</span> <span class="n">run</span>
</pre></div>
</div>
<p>Make sure you have the latest rebar3 release before trying this otherwise it won’t work.</p>
</div>
<div class="section" id="testing-it">
<h2>Testing it<a class="headerlink" href="#testing-it" title="Permalink to this headline">¶</a></h2>
<p>To interact with the REST API we will use httpie since it’s simpler to read
(and write) than curl, check how to install it on
<a class="reference external" href="http://httpie.org">the httpie website</a></p>
<p>First we build it and run it as usual (this may be the last time I show you explicitly how to do it, so learn it :):</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>rebar3 release
rebar3 run
</pre></div>
</div>
<p>Now on another shell we will make an HTTP request to our ping resource:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>http localhost:8080/ping
</pre></div>
</div>
<p>And this is what I get:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">content-length</span><span class="o">:</span> <span class="l">59</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">date</span><span class="o">:</span> <span class="l">Thu, 29 Oct 2015 19:07:23 GMT</span>
<span class="na">server</span><span class="o">:</span> <span class="l">Cowboy</span>

<span class="p">{</span>
<span class="nt">&quot;pong&quot;</span><span class="p">:</span> <span class="s2">&quot;981946412581700398168100746981252653831329677312&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you run it more times the value of the <cite>pong</cite> attribute should change, since
the vnode that handles the request <a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/220bcade820538aec05993065ac4edf19f3ebcde/apps/tanodb/src/tanodb.erl#L16">is defined by the time that the request is
made</a>.</p>
</div>
<div class="section" id="changing-some-configuration">
<h2>Changing Some Configuration<a class="headerlink" href="#changing-some-configuration" title="Permalink to this headline">¶</a></h2>
<p>Let’s say we would like to run the server on another port, for that we need
to change the configuration, we can do this by editing the file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">_build</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">rel</span><span class="o">/</span><span class="n">tanodb</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tanodb</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Search for 8080 and change it for 8081, save and close and stop the server if you are running it.</p>
<p>Now we will run it again but manually to avoid rebar3 from overriding our
change:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>./_build/default/rel/tanodb/bin/tanodb console
</pre></div>
</div>
<p>And try a request to see if the port is actually changed:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>http localhost:8081/ping
</pre></div>
</div>
<p>And this is what I get:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">content-length</span><span class="o">:</span> <span class="l">60</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">date</span><span class="o">:</span> <span class="l">Thu, 29 Oct 2015 19:18:03 GMT</span>
<span class="na">server</span><span class="o">:</span> <span class="l">Cowboy</span>

<span class="p">{</span>
    <span class="nt">&quot;pong&quot;</span><span class="p">:</span> <span class="s2">&quot;1187470080331358621040493926581979953470445191168&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Read tanodb.config to see all the available options, this file is generated
using <a class="reference external" href="https://github.com/basho/cuttlefish">cuttlefish</a> which takes a
<a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/220bcade820538aec05993065ac4edf19f3ebcde/config/config.schema">schema we define</a> and uses it to generate
the default config file and later to validate the config file on startup
and generate configuration files that the Erlang runtime understands.</p>
<p>If you are curious you can see the generated config files after running the
server at least once under <cite>_build/default/rel/tanodb/generated.configs/</cite></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Little Riak Core Book</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="starting.html">Starting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ping as a Service (PaaS)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up">Setting Up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-changes-required-to-make-this-code-run-as-of-2016-05-03">UPDATE: changes required to make this code run as of 2016-05-03</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-it">Testing it</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changing-some-configuration">Changing Some Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="users-groups-and-permissions.html">Users, Groups and Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-a-command-works.html">How a Command Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding-our-first-commands.html">Adding our First Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="listing-keys-from-a-bucket.html">Listing Keys from a Bucket</a></li>
<li class="toctree-l1"><a class="reference internal" href="tolerating-node-failures.html">Tolerating Node Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_metadata.html">Riak Core Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_security.html">Riak Core Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_resize.html">Ring Resize Operations</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="starting.html" title="previous chapter">Starting</a></li>
      <li>Next: <a href="metrics.html" title="next chapter">Metrics</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Mariano Guerra, Heinz N. Gies.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/ping-as-a-service.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>