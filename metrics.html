<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Metrics &#8212; Little Riak Core Book 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Users, Groups and Permissions" href="users-groups-and-permissions.html" />
    <link rel="prev" title="Ping as a Service (PaaS)" href="ping-as-a-service.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="metrics">
<h1>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="api-metrics">
<h2>API Metrics<a class="headerlink" href="#api-metrics" title="Permalink to this headline">¶</a></h2>
<p>Since this is meant to be a production system we can&#8217;t be far along until we
add metrics, for this we will use <a class="reference external" href="https://github.com/Feuerlabs/exometer">exometer</a> which is already a dependency of riak_core so we don&#8217;t need to add it.</p>
<p>We start by defining a <a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/0ea3595aefce0f9098cb651eb33263933ce9d6e7/apps/tanodb/src/tanodb_metrics.erl">module named tanodb_metrics</a>.</p>
<p>The main functions we care about are :</p>
<dl class="docutils">
<dt><a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/0ea3595aefce0f9098cb651eb33263933ce9d6e7/apps/tanodb/src/tanodb_metrics.erl#L16">init/0</a></dt>
<dd>which will initialize all the metrics when the app starts, we will add more metrics here as we add more features.</dd>
<dt><a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/0ea3595aefce0f9098cb651eb33263933ce9d6e7/apps/tanodb/src/tanodb_metrics.erl#L14">core_ping/0</a></dt>
<dd>should be called to register metrics about calls to <a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/0ea3595aefce0f9098cb651eb33263933ce9d6e7/apps/tanodb/src/tanodb.erl#L15">tanodb:ping/0</a></dd>
<dt><a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/0ea3595aefce0f9098cb651eb33263933ce9d6e7#diff-afa3f67ec87f742d64ee9ed311455777R8">all/0</a></dt>
<dd>returns the current status of all metrics.</dd>
</dl>
<p>To make the metrics actually work we need to call <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/0ea3595aefce0f9098cb651eb33263933ce9d6e7#diff-4477d4dd0aa2db0e274a56c9158207bdR13">tanodb_metrics:init/0</a> when we start the application and <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/0ea3595aefce0f9098cb651eb33263933ce9d6e7#diff-6f7251bf9e224ebabd766f0331b848adR16">tanodb_metrics:core_ping/0</a> each time tanodb:ping/0 is called.</p>
<div class="section" id="test-it">
<h3>Test It<a class="headerlink" href="#test-it" title="Permalink to this headline">¶</a></h3>
<p>Stop, build a release and run the server (I won&#8217;t tell you how from now on, check previous chapters to see how).</p>
<p>On the server shell run:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

 <span class="p">...</span>

 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}]}]</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">tanodb</span><span class="p">:</span><span class="nf">ping</span><span class="p">().</span>
<span class="p">{</span><span class="n">pong</span><span class="p">,</span><span class="mi">593735040165679310520246963290989976735222595584</span><span class="p">}</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

 <span class="p">...</span>

 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}]}]</span>

<span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">4</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <cite>...</cite> are there to skip a lot of metrics about riak_core itself that
are quite useful but not important at this point.</p>
<p>Let&#8217;s see the shell session step by step, first we call tanodb_metrics:all()
and get the core ping metrics, in this case count and one are 0 since we
didn&#8217;t call ping yet.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

 <span class="p">...</span>

 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}]}]</span>
</pre></div>
</div>
<p>Then we call ping once.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">tanodb</span><span class="p">:</span><span class="nf">ping</span><span class="p">().</span>
<span class="p">{</span><span class="n">pong</span><span class="p">,</span><span class="mi">593735040165679310520246963290989976735222595584</span><span class="p">}</span>
</pre></div>
</div>
<p>And ask for the metrics again, we can see that now it registered our call.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

 <span class="p">...</span>

 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}]}]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="erlang-runtime-metrics">
<h2>Erlang Runtime Metrics<a class="headerlink" href="#erlang-runtime-metrics" title="Permalink to this headline">¶</a></h2>
<p>Until now we have metrics for riak_core and for our API, it would be useful to
have some metrics about the Erlang Runtime, like memory, GC, processes,
schedulers etc. For that we will use a really nice library called <a class="reference external" href="https://github.com/ferd/recon">recon</a> which unified all the information gathering behind
a nice API.</p>
<p>We start by <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8d6535f360d24a1486bd7b1ed14d7fcde8c465bb#diff-31d7a50c99c265ca2793c20961b60979R6">adding recon as a dependency</a>,  then we <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8d6535f360d24a1486bd7b1ed14d7fcde8c465bb#diff-afa3f67ec87f742d64ee9ed311455777R24">create the function tanodb_metrics:node_stats/0</a> and add it to <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8d6535f360d24a1486bd7b1ed14d7fcde8c465bb#diff-afa3f67ec87f742d64ee9ed311455777R10">tanodb_metrics:all/0</a>.</p>
<div class="section" id="id1">
<h3>Test it<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Stop, build a release and run. In the shell run:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

    <span class="p">...</span>

 <span class="p">{</span><span class="nb">node</span><span class="p">,[{</span><span class="nb">abs</span><span class="p">,[{</span><span class="n">process_count</span><span class="p">,</span><span class="mi">377</span><span class="p">},</span>
              <span class="p">{</span><span class="n">run_queue</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
              <span class="p">{</span><span class="n">error_logger_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_total</span><span class="p">,</span><span class="mi">30418240</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_procs</span><span class="p">,</span><span class="mi">11745496</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_atoms</span><span class="p">,</span><span class="mi">458994</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_bin</span><span class="p">,</span><span class="mi">232112</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_ets</span><span class="p">,</span><span class="mi">1470872</span><span class="p">}]},</span>
        <span class="p">{</span><span class="n">inc</span><span class="p">,[{</span><span class="n">bytes_in</span><span class="p">,</span><span class="mi">11737</span><span class="p">},</span>
              <span class="p">{</span><span class="n">bytes_out</span><span class="p">,</span><span class="mi">2470</span><span class="p">},</span>
              <span class="p">{</span><span class="n">gc_count</span><span class="p">,</span><span class="mi">7</span><span class="p">},</span>
              <span class="p">{</span><span class="n">gc_words_reclaimed</span><span class="p">,</span><span class="mi">29948</span><span class="p">},</span>
              <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">2601390</span><span class="p">},</span>
              <span class="p">{</span><span class="n">scheduler_usage</span><span class="p">,[{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">9291112866248371</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">04754016011809648</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">04615958261183974</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">03682005933534583</span><span class="p">}]}]}]},</span>
 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]}]}]</span>
</pre></div>
</div>
<p>The metrics should be self explanatory, check <a class="reference external" href="http://ferd.github.io/recon/">the recon documentation</a> for details.</p>
</div>
</div>
<div class="section" id="web-server-metrics-cowboy">
<h2>Web Server Metrics (Cowboy)<a class="headerlink" href="#web-server-metrics-cowboy" title="Permalink to this headline">¶</a></h2>
<p>We will start with some generic web server metrics, you can add specific ones
with what you have learned in this chapter and by reading <a class="reference external" href="https://github.com/Feuerlabs/exometer/tree/master/doc">the exometer docs</a>.</p>
<p>For the generic metrics we will use <a class="reference external" href="https://github.com/marianoguerra/cowboy_exometer">cowboy_exometer</a> which is a module I just wrote since it was quite generic :)</p>
<p>We start by adding the <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8fb792bc01ac58fbdc709a0c9d2f960605255e54#diff-31d7a50c99c265ca2793c20961b60979R7">cowboy_exometer dependency</a>, this module exposes a middleware and a response hook
to register metrics on all requests, for that we need to <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8fb792bc01ac58fbdc709a0c9d2f960605255e54#diff-afa3f67ec87f742d64ee9ed311455777R20">initialize it providing the endpoints we care about</a> and when we want to collect the metrics we <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8fb792bc01ac58fbdc709a0c9d2f960605255e54#diff-afa3f67ec87f742d64ee9ed311455777R11">call cowboy_exometer:stats/1 passing the same endpoints we passed on init</a>.</p>
<p>Finally we need to tell cowboy that we will <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/8fb792bc01ac58fbdc709a0c9d2f960605255e54#diff-4477d4dd0aa2db0e274a56c9158207bdR38">add a middleware and a response hook</a>.</p>
<div class="section" id="id2">
<h3>Test it<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>After all of this, stop, build, run and make some requests:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>http localhost:8080/ping
</pre></div>
</div>
<p>and then on the node shell ask for the metrics:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tanodb</span><span class="p">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">tanodb_metrics</span><span class="p">:</span><span class="nf">all</span><span class="p">().</span>
<span class="p">[{</span><span class="n">tanodb</span><span class="p">,[</span>

    <span class="p">...</span>

 <span class="p">{</span><span class="n">http</span><span class="p">,[{</span><span class="n">resp</span><span class="p">,[{</span><span class="n">by_code</span><span class="p">,[{</span><span class="mi">200</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">201</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">202</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">203</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">204</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">205</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">206</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">300</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">301</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">302</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">303</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">304</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">305</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">0</span><span class="p">}]},</span>
                         <span class="p">{</span><span class="mi">306</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">one</span><span class="p">,...}]},</span>
                         <span class="p">{</span><span class="mi">307</span><span class="p">,[{</span><span class="n">count</span><span class="p">,...},{...}]},</span>
                         <span class="p">{</span><span class="mi">308</span><span class="p">,[{...}|...]},</span>
                         <span class="p">{</span><span class="mi">400</span><span class="p">,[...]},</span>
                         <span class="p">{</span><span class="mi">401</span><span class="p">,...},</span>
                         <span class="p">{...}|...]}]},</span>
        <span class="p">{</span><span class="n">req</span><span class="p">,[{</span><span class="n">time</span><span class="p">,[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;ping&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
                      <span class="p">[{</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
                       <span class="p">{</span><span class="n">mean</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="n">min</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="n">max</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="n">median</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">75</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">90</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">95</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">99</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
                       <span class="p">{</span><span class="mi">999</span><span class="p">,</span><span class="mi">44126</span><span class="p">}]}]},</span>
              <span class="p">{</span><span class="n">active</span><span class="p">,[{</span><span class="n">value</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="n">ms_since_reset</span><span class="p">,</span><span class="mi">11546</span><span class="p">}]},</span>
              <span class="p">{</span><span class="n">count</span><span class="p">,[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;ping&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}]}]}]},</span>
 <span class="p">{</span><span class="nb">node</span><span class="p">,[{</span><span class="nb">abs</span><span class="p">,[{</span><span class="n">process_count</span><span class="p">,</span><span class="mi">428</span><span class="p">},</span>
              <span class="p">{</span><span class="n">run_queue</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
              <span class="p">{</span><span class="n">error_logger_queue_len</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_total</span><span class="p">,</span><span class="mi">50301760</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_procs</span><span class="p">,</span><span class="mi">30854096</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_atoms</span><span class="p">,</span><span class="mi">471201</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_bin</span><span class="p">,</span><span class="mi">222648</span><span class="p">},</span>
              <span class="p">{</span><span class="n">memory_ets</span><span class="p">,</span><span class="mi">1574728</span><span class="p">}]},</span>
        <span class="p">{</span><span class="n">inc</span><span class="p">,[{</span><span class="n">bytes_in</span><span class="p">,</span><span class="mi">11737</span><span class="p">},</span>
              <span class="p">{</span><span class="n">bytes_out</span><span class="p">,</span><span class="mi">2470</span><span class="p">},</span>
              <span class="p">{</span><span class="n">gc_count</span><span class="p">,</span><span class="mi">6</span><span class="p">},</span>
              <span class="p">{</span><span class="n">gc_words_reclaimed</span><span class="p">,</span><span class="mi">29747</span><span class="p">},</span>
              <span class="p">{</span><span class="n">reductions</span><span class="p">,</span><span class="mi">2848780</span><span class="p">},</span>
              <span class="p">{</span><span class="n">scheduler_usage</span><span class="p">,[{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">05329944038387727</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">8991375098414373</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">03932163131802264</span><span class="p">},</span>
                                <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">05719991628720056</span><span class="p">}]}]}]},</span>
 <span class="p">{</span><span class="n">core</span><span class="p">,[{</span><span class="n">ping</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}]}]</span>
</pre></div>
</div>
<p>You can see on this line that I made one request to ping and it returned 200:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">http</span><span class="p">,[{</span><span class="n">resp</span><span class="p">,[{</span><span class="n">by_code</span><span class="p">,[{</span><span class="mi">200</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]},</span>
</pre></div>
</div>
<p>You can also see request time stats per endpoint:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">req</span><span class="p">,[{</span><span class="n">time</span><span class="p">,[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;ping&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
              <span class="p">[{</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>
               <span class="p">{</span><span class="n">mean</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="n">min</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="n">max</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="n">median</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">75</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">90</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">95</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">99</span><span class="p">,</span><span class="mi">44126</span><span class="p">},</span>
               <span class="p">{</span><span class="mi">999</span><span class="p">,</span><span class="mi">44126</span><span class="p">}]}]},</span>
</pre></div>
</div>
<p>And request count by endpoint:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">count</span><span class="p">,[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;ping&quot;</span><span class="o">&gt;&gt;</span><span class="p">,[{</span><span class="n">count</span><span class="p">,</span><span class="mi">1</span><span class="p">},{</span><span class="n">one</span><span class="p">,</span><span class="mi">1</span><span class="p">}]}]}]}]},</span>
</pre></div>
</div>
</div>
<div class="section" id="exposing-metrics-as-a-rest-resource">
<h3>Exposing Metrics as a REST resource<a class="headerlink" href="#exposing-metrics-as-a-rest-resource" title="Permalink to this headline">¶</a></h3>
<p>This one will be simple, first we <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/de3dde8187ceefdeb787eb835a6e36e80528de6f#diff-4477d4dd0aa2db0e274a56c9158207bdR33">add the route to cowboy</a> then <a class="reference external" href="https://github.com/marianoguerra/tanodb/commit/de3dde8187ceefdeb787eb835a6e36e80528de6f#diff-afa3f67ec87f742d64ee9ed311455777R6">add the metrics endpoint to the list of endpoints we want to collect metrics</a> (metricception) and finally <a class="reference external" href="https://github.com/marianoguerra/tanodb/blob/de3dde8187ceefdeb787eb835a6e36e80528de6f/apps/tanodb/src/tanodb_http_metrics.erl">we implement the cowboy handler to return the json</a>.</p>
<div class="section" id="id3">
<h4>Test it<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Stop, build, start and make some requests:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>http localhost:8080/ping
</pre></div>
</div>
<p>And then make a request for the metrics (result edited since it&#8217;s quite big):</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>$ http localhost:8080/metrics
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span></span>HTTP/1.1 200 OK
content-length: 8079
content-type: application/json
date: Fri, 30 Oct 2015 10:39:27 GMT
server: Cowboy

{
    &quot;core&quot;: {
        &quot;ping&quot;: { &quot;count&quot;: 2, &quot;one&quot;: 1 }
    },
    &quot;http&quot;: {
        &quot;req&quot;: {
            &quot;active&quot;: { &quot;ms_since_reset&quot;: 279958, &quot;value&quot;: 1 },
            &quot;count&quot;: {
                &quot;metrics&quot;: { &quot;count&quot;: 1, &quot;one&quot;: 0 },
                &quot;ping&quot;: { &quot;count&quot;: 2, &quot;one&quot;: 1 }
            },
            &quot;time&quot;: {
                &quot;metrics&quot;: {
                    &quot;50&quot;: 0,
                    &quot;75&quot;: 0,
                    &quot;90&quot;: 0,
                    &quot;95&quot;: 0,
                    &quot;99&quot;: 0,
                    &quot;999&quot;: 0,
                    &quot;max&quot;: 0,
                    &quot;mean&quot;: 0,
                    &quot;median&quot;: 0,
                    &quot;min&quot;: 0,
                    &quot;n&quot;: 0
                },
                &quot;ping&quot;: {
                    &quot;50&quot;: 0,
                    &quot;75&quot;: 349,
                    &quot;90&quot;: 349,
                    &quot;95&quot;: 349,
                    &quot;99&quot;: 349,
                    &quot;999&quot;: 349,
                    &quot;max&quot;: 349,
                    &quot;mean&quot;: 349,
                    &quot;median&quot;: 349,
                    &quot;min&quot;: 349,
                    &quot;n&quot;: 3
                }
            }
        },
        &quot;resp&quot;: {
            &quot;by_code&quot;: {
                &quot;200&quot;: { &quot;count&quot;: 3, &quot;one&quot;: 1 },
                &quot;201&quot;: { &quot;count&quot;: 0, &quot;one&quot;: 0 },
                ...
                &quot;400&quot;: { &quot;count&quot;: 0, &quot;one&quot;: 0 },
                &quot;401&quot;: { &quot;count&quot;: 0, &quot;one&quot;: 0 },
                ...
                &quot;404&quot;: { &quot;count&quot;: 0, &quot;one&quot;: 0 },
                ...
                &quot;500&quot;: { &quot;count&quot;: 0, &quot;one&quot;: 0 },
                ...
            }
        }
    },
    &quot;node&quot;: {
        &quot;abs&quot;: {
            &quot;error_logger_queue_len&quot;: 0,
            &quot;memory_atoms&quot;: 471362,
            &quot;memory_bin&quot;: 224392,
            &quot;memory_ets&quot;: 1579592,
            &quot;memory_procs&quot;: 31886248,
            &quot;memory_total&quot;: 51342840,
            &quot;process_count&quot;: 432,
            &quot;run_queue&quot;: 0
        },
        &quot;inc&quot;: {
            &quot;bytes_in&quot;: 0,
            &quot;bytes_out&quot;: 0,
            &quot;gc_count&quot;: 2,
            &quot;gc_words_reclaimed&quot;: 6624,
            &quot;reductions&quot;: 695770,
            &quot;scheduler_usage&quot;: {
                &quot;1&quot;: 0.16108125753314584,
                &quot;2&quot;: 0.5187896583972728,
                &quot;3&quot;: 0.18046079477682214,
                &quot;4&quot;: 0.15292436095407036
            }
        }
    },
    &quot;tanodb&quot;: {
        ...
    }
}
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Little Riak Core Book</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="starting.html">Starting</a></li>
<li class="toctree-l1"><a class="reference internal" href="ping-as-a-service.html">Ping as a Service (PaaS)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Metrics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#api-metrics">API Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#erlang-runtime-metrics">Erlang Runtime Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#web-server-metrics-cowboy">Web Server Metrics (Cowboy)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="users-groups-and-permissions.html">Users, Groups and Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-a-command-works.html">How a Command Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding-our-first-commands.html">Adding our First Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="listing-keys-from-a-bucket.html">Listing Keys from a Bucket</a></li>
<li class="toctree-l1"><a class="reference internal" href="tolerating-node-failures.html">Tolerating Node Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_metadata.html">Riak Core Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_security.html">Riak Core Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="riak_core_resize.html">Ring Resize Operations</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ping-as-a-service.html" title="previous chapter">Ping as a Service (PaaS)</a></li>
      <li>Next: <a href="users-groups-and-permissions.html" title="next chapter">Users, Groups and Permissions</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Mariano Guerra, Heinz N. Gies.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/metrics.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>